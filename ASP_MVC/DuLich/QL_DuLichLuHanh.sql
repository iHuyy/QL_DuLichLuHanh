CREATE TABLE KhachHang (
    MaKhachHang NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    HoTen NVARCHAR2(100),
    Email NVARCHAR2(100) UNIQUE NOT NULL,
    SoDienThoai NVARCHAR2(20),
    DiaChi NVARCHAR2(200),
    VaiTro NVARCHAR2(20) DEFAULT 'KhachHang' CHECK (VaiTro IN ('Admin', 'KhachHang','NhanVien')),
    TrangThai NVARCHAR2(20) DEFAULT 'HoatDong' CHECK (TrangThai IN ('HoatDong', 'BiKhoa')),
    NgayTao DATE DEFAULT SYSDATE,
    ORACLE_USERNAME NVARCHAR2(100),
    QR_CODE NVARCHAR2(500)
);

CREATE TABLE NhanVien (
    MaNhanVien NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    HoTen NVARCHAR2(100),
    Email NVARCHAR2(100) UNIQUE NOT NULL,
    SoDienThoai NVARCHAR2(20),
    VaiTro NVARCHAR2(20) DEFAULT 'NhanVien' CHECK (VaiTro IN ('Admin', 'NhanVien')),
    TrangThai NVARCHAR2(20) DEFAULT 'HoatDong' CHECK (TrangThai IN ('HoatDong', 'BiKhoa')),
    NgayTao DATE DEFAULT SYSDATE,
    ChiNhanh NVARCHAR2(100),
    QR_CODE NVARCHAR2(500),
    ORACLE_USERNAME NVARCHAR2(100)
);
-- ==============================================
-- 2ï¸âƒ£ Báº¢NG CÆ  Sá»ž Dá»® LIá»†U Dá»ŠCH Vá»¤ & NHÃ€ CUNG Cáº¤P
-- ==============================================
CREATE TABLE LoaiDichVu (
    MaLoaiDichVu NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    TenLoaiDichVu NVARCHAR2(100) NOT NULL,
    MoTa NVARCHAR2(300)
);

CREATE TABLE DichVu (
    MaDichVu NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    TenDichVu NVARCHAR2(150) NOT NULL,
    GiaCoBan NUMBER(12,2),
    MoTa NVARCHAR2(300),
    MaLoaiDichVu NUMBER,
    CONSTRAINT fk_dv_loaidv FOREIGN KEY (MaLoaiDichVu) REFERENCES LoaiDichVu(MaLoaiDichVu)
);

CREATE TABLE NhaCungCap (
    MaNhaCungCap NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    TenNhaCungCap NVARCHAR2(150) NOT NULL,
    DiaChi NVARCHAR2(200),
    SoDienThoai NVARCHAR2(20),
    Email NVARCHAR2(100),
    Website NVARCHAR2(100)
);

CREATE TABLE NhaCungCap_DichVu (
    MaNhaCungCap NUMBER,
    MaDichVu NUMBER,
    GiaCungUng NUMBER(12,2),
    DieuKien NVARCHAR2(200),
    CONSTRAINT pk_nccdv PRIMARY KEY (MaNhaCungCap, MaDichVu),
    CONSTRAINT fk_nccdv_ncc FOREIGN KEY (MaNhaCungCap) REFERENCES NhaCungCap(MaNhaCungCap),
    CONSTRAINT fk_nccdv_dv FOREIGN KEY (MaDichVu) REFERENCES DichVu(MaDichVu)
);

CREATE TABLE Tour (
    MaTour NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    TieuDe NVARCHAR2(200),
    MoTa NVARCHAR2(500),
    NoiKhoiHanh NVARCHAR2(100),
    NoiDen NVARCHAR2(100),
    ThanhPho NVARCHAR2(100),
    ThoiGian DATE,
    GiaNguoiLon NUMBER(12,2),
    GiaTreEm NUMBER(12,2),
    TrangThai NVARCHAR2(50) DEFAULT 'Hoáº¡t Ä‘á»™ng' CHECK (TrangThai IN ('Hoáº¡t Ä‘á»™ng', 'Táº¡m ngÆ°ng', 'ÄÃ£ káº¿t thÃºc', 'ÄÃ£ há»§y', 'áº¨n'));
    SoLuong NUMBER,
    QR NVARCHAR2(500),
    ChiNhanh NVARCHAR2(100)
);

CREATE TABLE ChiTietTour (
    MaTour NUMBER,
    MaDichVu NUMBER,
    SoLuong NUMBER,
    CONSTRAINT pk_cttour PRIMARY KEY (MaTour, MaDichVu),
    CONSTRAINT fk_cttour_tour FOREIGN KEY (MaTour) REFERENCES Tour(MaTour),
    CONSTRAINT fk_cttour_dv FOREIGN KEY (MaDichVu) REFERENCES DichVu(MaDichVu)
);

CREATE TABLE AnhTour (
    MaAnh NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MaTour NUMBER,
    DuongDanAnh NVARCHAR2(300),
    MoTa NVARCHAR2(200),
    NgayTaiLen DATE DEFAULT SYSDATE,
    CONSTRAINT fk_anh_tour FOREIGN KEY (MaTour) REFERENCES Tour(MaTour)
);

CREATE TABLE DatTour (
    MaDatTour NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MaKhachHang NUMBER,
    MaTour NUMBER,
    NgayDat DATE DEFAULT SYSDATE,
    SoNguoiLon NUMBER,
    SoTreEm NUMBER,
    TongTien NUMBER(12,2),
    TrangThaiThanhToan NVARCHAR2(20),
    TrangThaiDat NVARCHAR2(20),
    YeuCauDacBiet NVARCHAR2(200),
    CONSTRAINT fk_dattour_kh FOREIGN KEY (MaKhachHang) REFERENCES KhachHang(MaKhachHang),
    CONSTRAINT fk_dattour_tour FOREIGN KEY (MaTour) REFERENCES Tour(MaTour)
);

CREATE TABLE HoaDon (
    MaHoaDon NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MaDatTour NUMBER,
    SoTien NUMBER(12,2),
    NgayXuat DATE DEFAULT SYSDATE,
    TrangThai NVARCHAR2(20),
    ChuKySo NVARCHAR2(500),
    CONSTRAINT fk_hd_dt FOREIGN KEY (MaDatTour) REFERENCES DatTour(MaDatTour)
);

CREATE TABLE DanhGiaTour (
    MaDanhGia NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MaKhachHang NUMBER NOT NULL,
    MaTour NUMBER NOT NULL,
    SoSao NUMBER CHECK (SoSao BETWEEN 1 AND 5),
    NoiDungDanhGia NVARCHAR2(300),
    NgayDanhGia DATE DEFAULT SYSDATE,
    CONSTRAINT fk_dg_kh FOREIGN KEY (MaKhachHang) REFERENCES KhachHang(MaKhachHang),
    CONSTRAINT fk_dg_tour FOREIGN KEY (MaTour) REFERENCES Tour(MaTour)
);

CREATE TABLE TinNhan (
    MaTinNhan NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MaKhachHang NUMBER,
    NoiDung NVARCHAR2(500),
    NgayGui DATE DEFAULT SYSDATE,
    DaDoc CHAR(1) DEFAULT 'N',
    CONSTRAINT fk_tn_kh FOREIGN KEY (MaKhachHang) REFERENCES KhachHang(MaKhachHang)
);

CREATE TABLE NhatKyHeThong (
    MaNhatKy NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    TenBang NVARCHAR2(100),
    HanhDong NVARCHAR2(50),
    ThoiGian DATE DEFAULT SYSDATE,
    NguoiThucHien NVARCHAR2(50)
);

CREATE TABLE QR_Login (
    Id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    SessionKey NVARCHAR2(100) UNIQUE,
    UserId NUMBER,
    IsUsed NUMBER(1) DEFAULT 0,
    CreatedAt DATE DEFAULT SYSDATE,
    CONSTRAINT fk_qr_user FOREIGN KEY (UserId) REFERENCES KhachHang(MaKhachHang)
);



-- =====================================================
-- ðŸ” 4. PROFILE KIá»‚M SOÃT ÄÄ‚NG NHáº¬P
-- =====================================================
CREATE PROFILE admin_profile LIMIT
    FAILED_LOGIN_ATTEMPTS 3             -- Sai máº­t kháº©u 3 láº§n thÃ¬ khÃ³a
    PASSWORD_LOCK_TIME 0.0003472        -- KhÃ³a 30s
    PASSWORD_LIFE_TIME 90               -- Máº­t kháº©u háº¿t háº¡n sau 90 ngÃ y
    SESSIONS_PER_USER 3                 -- Tá»‘i Ä‘a 3 phiÃªn Ä‘Äƒng nháº­p Ä‘á»“ng thá»i
    IDLE_TIME 30                        -- Tá»± ngáº¯t náº¿u khÃ´ng hoáº¡t Ä‘á»™ng 30 phÃºt
    CONNECT_TIME 240                    -- Giá»›i háº¡n thá»i gian káº¿t ná»‘i 4 tiáº¿ng
    CPU_PER_SESSION UNLIMITED
    CPU_PER_CALL UNLIMITED
    LOGICAL_READS_PER_SESSION UNLIMITED;

CREATE PROFILE cus_profile LIMIT
    FAILED_LOGIN_ATTEMPTS 3
    PASSWORD_LOCK_TIME 0.0003472        -- KhÃ³a 30s
    PASSWORD_LIFE_TIME 180              -- KhÃ¡ch hÃ ng Ä‘á»•i máº­t kháº©u 6 thÃ¡ng 1 láº§n
    SESSIONS_PER_USER 1                 -- Chá»‰ 1 phiÃªn Ä‘Äƒng nháº­p duy nháº¥t
    IDLE_TIME 15                        -- Háº¿t hoáº¡t Ä‘á»™ng 15 phÃºt -> tá»± ngáº¯t
    CONNECT_TIME 120;                    -- Giá»›i háº¡n 2 tiáº¿ng má»—i láº§n Ä‘Äƒng nháº­p

CREATE PROFILE staff_profile LIMIT
    FAILED_LOGIN_ATTEMPTS 3
    PASSWORD_LIFE_TIME 90
    SESSIONS_PER_USER 1
    IDLE_TIME 30
    PASSWORD_GRACE_TIME 7;

-- =====================================================
-- ðŸ§© 5. ROLE PHÃ‚N QUYá»€N
-- =====================================================
CREATE ROLE ROLE_ADMIN;
CREATE ROLE ROLE_CUSTOMER;
CREATE ROLE ROLE_STAFF;
CREATE ROLE ROLE_READ_ONLY;

-- Quyá»n Ä‘Äƒng nháº­p
GRANT CREATE SESSION TO ROLE_ADMIN;
GRANT CREATE SESSION TO ROLE_CUSTOMER;

-- =====================================================
-- ðŸ›  6. Cáº¤P QUYá»€N CHI TIáº¾T
-- =====================================================

-- ADMIN cÃ³ toÃ n quyá»n
GRANT ALL PRIVILEGES TO ROLE_ADMIN;

-- CUSTOMER chá»‰ cÃ³ quyá»n thao tÃ¡c dá»¯ liá»‡u ngÆ°á»i dÃ¹ng vÃ  tour
GRANT SELECT ON KhachHang TO ROLE_CUSTOMER;
GRANT SELECT ON Tour TO ROLE_CUSTOMER;
GRANT SELECT, INSERT ON DatTour TO ROLE_CUSTOMER;
GRANT SELECT, INSERT ON DanhGiaTour TO ROLE_CUSTOMER;
GRANT SELECT, INSERT ON TinNhan TO ROLE_CUSTOMER;
GRANT SELECT, UPDATE ON KhachHang TO ROLE_CUSTOMER;

-- Chá»‰ cho phÃ©p xem trÃªn dá»¯ liá»‡u
GRANT SELECT ON KhachHang TO ROLE_READ_ONLY;
GRANT SELECT ON Tour TO ROLE_READ_ONLY;
GRANT SELECT ON DatTour TO ROLE_READ_ONLY;
GRANT SELECT ON DichVu TO ROLE_READ_ONLY;

-- Quyá»n cho nhÃ¢n viÃªn
GRANT SELECT, UPDATE ON Tour TO ROLE_STAFF;
GRANT SELECT, UPDATE ON DichVu TO ROLE_STAFF;
GRANT SELECT, INSERT ON KhachHang TO ROLE_STAFF;
GRANT SELECT, INSERT ON DatTour TO ROLE_STAFF;
GRANT SELECT, INSERT, UPDATE ON HoaDon TO ROLE_STAFF;
GRANT CREATE SESSION TO ROLE_STAFF;

-- =====================================================
-- ðŸ‘¥ 7. Táº O USER TRONG ORACLE
-- =====================================================
CREATE USER admin1 IDENTIFIED BY 123456
    PROFILE admin_profile
    DEFAULT TABLESPACE USERS
    TEMPORARY TABLESPACE TEMP;
GRANT ROLE_ADMIN TO admin1;
GRANT UNLIMITED TABLESPACE TO admin1;


CREATE USER cus1 IDENTIFIED BY 123456
    PROFILE cust_profile
    DEFAULT TABLESPACE USERS
    TEMPORARY TABLESPACE TEMP;
GRANT ROLE_CUSTOMER TO cus1;
GRANT UNLIMITED TABLESPACE TO cus1;

CREATE USER staff1 IDENTIFIED BY 123456
    PROFILE staff_profile
    DEFAULT TABLESPACE USERS
    TEMPORARY TABLESPACE TEMP;
GRANT ROLE_STAFF TO cus1;
GRANT ROLE_STAFF TO staff1;

-- =====================================================
-- ðŸ‘¥ 8. PhÃ¢n quyá»n truy cáº­p theo chi nhÃ¡nh báº±ng VPD
-- =====================================================
CREATE OR REPLACE FUNCTION fn_vpd_nhanvien (
    schema_name VARCHAR2, 
    table_name  VARCHAR2
) RETURN VARCHAR2 AS
BEGIN
  -- Má»—i nhÃ¢n viÃªn chá»‰ tháº¥y dá»¯ liá»‡u thuá»™c chi nhÃ¡nh cá»§a há»
  RETURN 'ChiNhanh = SYS_CONTEXT(''USERENV'', ''CLIENT_IDENTIFIER'')';
END;
BEGIN
  DBMS_RLS.ADD_POLICY(
    object_schema   => 'TADMIN',
    object_name     => 'TOUR',
    policy_name     => 'POLICY_TOUR_NHANVIEN',
    function_schema => 'TADMIN',
    policy_function => 'fn_vpd_nhanvien',
    statement_types => 'SELECT'
  );
END;
-- =====================================================
-- ðŸ‘¥ 8. Trigger
-- =====================================================
-- GÃ¡n tour cho tÃ i khoáº£n nhÃ¢n viÃªn
CREATE OR REPLACE TRIGGER trg_tour_chinhanh
BEFORE INSERT ON TOUR
FOR EACH ROW
BEGIN
  :NEW.ChiNhanh := SYS_CONTEXT('USERENV', 'CLIENT_IDENTIFIER');
END;