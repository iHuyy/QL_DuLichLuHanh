CREATE TABLE KhachHang (
    MaKhachHang NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    HoTen NVARCHAR2(100),
    Email NVARCHAR2(100) UNIQUE NOT NULL,
    SoDienThoai NVARCHAR2(20),
    DiaChi NVARCHAR2(200),
    VaiTro NVARCHAR2(20) DEFAULT 'KhachHang' CHECK (VaiTro IN ('Admin', 'KhachHang','NhanVien')),
    TrangThai NVARCHAR2(20) DEFAULT 'HoatDong' CHECK (TrangThai IN ('HoatDong', 'BiKhoa')),
    NgayTao DATE DEFAULT SYSDATE,
    ORACLE_USERNAME NVARCHAR2(100),
    QR_CODE NVARCHAR2(500)
);

CREATE TABLE NhanVien (
    MaNhanVien NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    HoTen NVARCHAR2(100),
    Email NVARCHAR2(100) UNIQUE NOT NULL,
    SoDienThoai NVARCHAR2(20),
    VaiTro NVARCHAR2(20) DEFAULT 'NhanVien' CHECK (VaiTro IN ('Admin', 'NhanVien')),
    TrangThai NVARCHAR2(20) DEFAULT 'HoatDong' CHECK (TrangThai IN ('HoatDong', 'BiKhoa')),
    NgayTao DATE DEFAULT SYSDATE,
    QR_CODE NVARCHAR2(500),
    MaChiNhanh NUMBER,
    ORACLE_USERNAME NVARCHAR2(100),
    CONSTRAINT fk_nv_cn FOREIGN KEY (MaChiNhanh) REFERENCES ChiNhanh(MaChiNhanh);
);
-- ==============================================
-- 2Ô∏è‚É£ B·∫¢NG C∆† S·ªû D·ªÆ LI·ªÜU D·ªäCH V·ª§ & NH√Ä CUNG C·∫§P
-- ==============================================
CREATE TABLE LoaiDichVu (
    MaLoaiDichVu NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    TenLoaiDichVu NVARCHAR2(100) NOT NULL,
    MoTa NVARCHAR2(300)
);

CREATE TABLE DichVu (
    MaDichVu NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    TenDichVu NVARCHAR2(150) NOT NULL,
    GiaCoBan NUMBER(12,2),
    MoTa NVARCHAR2(300),
    MaLoaiDichVu NUMBER,
    CONSTRAINT fk_dv_loaidv FOREIGN KEY (MaLoaiDichVu) REFERENCES LoaiDichVu(MaLoaiDichVu)
);

CREATE TABLE NhaCungCap (
    MaNhaCungCap NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    TenNhaCungCap NVARCHAR2(150) NOT NULL,
    DiaChi NVARCHAR2(200),
    SoDienThoai NVARCHAR2(20),
    Email NVARCHAR2(100),
    Website NVARCHAR2(100)
);

CREATE TABLE NhaCungCap_DichVu (
    MaNhaCungCap NUMBER,
    MaDichVu NUMBER,
    GiaCungUng NUMBER(12,2),
    DieuKien NVARCHAR2(200),
    CONSTRAINT pk_nccdv PRIMARY KEY (MaNhaCungCap, MaDichVu),
    CONSTRAINT fk_nccdv_ncc FOREIGN KEY (MaNhaCungCap) REFERENCES NhaCungCap(MaNhaCungCap),
    CONSTRAINT fk_nccdv_dv FOREIGN KEY (MaDichVu) REFERENCES DichVu(MaDichVu)
);

CREATE TABLE Tour (
    MaTour NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    TieuDe NVARCHAR2(200),
    MoTa NVARCHAR2(500),
    NoiKhoiHanh NVARCHAR2(100),
    NoiDen NVARCHAR2(100),
    ThanhPho NVARCHAR2(100),
    ThoiGian DATE,
    GiaNguoiLon NUMBER(12,2),
    GiaTreEm NUMBER(12,2),
    TrangThai NVARCHAR2(50) DEFAULT 'Ho·∫°t ƒë·ªông' CHECK (TrangThai IN ('Ho·∫°t ƒë·ªông', 'T·∫°m ng∆∞ng', 'ƒê√£ k·∫øt th√∫c', 'ƒê√£ h·ªßy', '·∫®n'));
    SoLuong NUMBER,
    QR NVARCHAR2(500),
    MaChiNhanh NUMBER,
    ChiNhanh NVARCHAR2(100),
    CONSTRAINT fk_tour_cn FOREIGN KEY (MaChiNhanh) REFERENCES ChiNhanh(MaChiNhanh);
);

CREATE TABLE ChiTietTour (
    MaTour NUMBER,
    MaDichVu NUMBER,
    SoLuong NUMBER,
    CONSTRAINT pk_cttour PRIMARY KEY (MaTour, MaDichVu),
    CONSTRAINT fk_cttour_tour FOREIGN KEY (MaTour) REFERENCES Tour(MaTour),
    CONSTRAINT fk_cttour_dv FOREIGN KEY (MaDichVu) REFERENCES DichVu(MaDichVu)
);

CREATE TABLE AnhTour (
    MaAnh NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MaTour NUMBER,
    DuongDanAnh NVARCHAR2(300),
    MoTa NVARCHAR2(200),
    NgayTaiLen DATE DEFAULT SYSDATE,
    CONSTRAINT fk_anh_tour FOREIGN KEY (MaTour) REFERENCES Tour(MaTour)
);

CREATE TABLE DatTour (
    MaDatTour NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MaKhachHang NUMBER,
    MaTour NUMBER,
    NgayDat DATE DEFAULT SYSDATE,
    SoNguoiLon NUMBER,
    SoTreEm NUMBER,
    TongTien NUMBER(12,2),
    TrangThaiThanhToan NVARCHAR2(20),
    TrangThaiDat NVARCHAR2(20),
    YeuCauDacBiet NVARCHAR2(200),
    CONSTRAINT fk_dattour_kh FOREIGN KEY (MaKhachHang) REFERENCES KhachHang(MaKhachHang),
    CONSTRAINT fk_dattour_tour FOREIGN KEY (MaTour) REFERENCES Tour(MaTour)
);

CREATE TABLE HoaDon (
    MaHoaDon NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MaDatTour NUMBER,
    SoTien NUMBER(12,2),
    NgayXuat DATE DEFAULT SYSDATE,
    TrangThai NVARCHAR2(20),
    ChuKySo NVARCHAR2(500),
    CONSTRAINT fk_hd_dt FOREIGN KEY (MaDatTour) REFERENCES DatTour(MaDatTour)
);

CREATE TABLE DanhGiaTour (
    MaDanhGia NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MaKhachHang NUMBER NOT NULL,
    MaTour NUMBER NOT NULL,
    SoSao NUMBER CHECK (SoSao BETWEEN 1 AND 5),
    NoiDungDanhGia NVARCHAR2(300),
    NgayDanhGia DATE DEFAULT SYSDATE,
    CONSTRAINT fk_dg_kh FOREIGN KEY (MaKhachHang) REFERENCES KhachHang(MaKhachHang),
    CONSTRAINT fk_dg_tour FOREIGN KEY (MaTour) REFERENCES Tour(MaTour)
);

CREATE TABLE TinNhan (
    MaTinNhan NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MaKhachHang NUMBER,
    NoiDung NVARCHAR2(500),
    NgayGui DATE DEFAULT SYSDATE,
    DaDoc CHAR(1) DEFAULT 'N',
    CONSTRAINT fk_tn_kh FOREIGN KEY (MaKhachHang) REFERENCES KhachHang(MaKhachHang)
);

CREATE TABLE NhatKyHeThong (
    MaNhatKy NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    TenBang NVARCHAR2(100),
    HanhDong NVARCHAR2(50),
    ThoiGian DATE DEFAULT SYSDATE,
    NguoiThucHien NVARCHAR2(50)
);

CREATE TABLE QR_Login (
    Id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    SessionKey NVARCHAR2(100) UNIQUE,
    UserId NUMBER,
    IsUsed NUMBER(1) DEFAULT 0,
    CreatedAt DATE DEFAULT SYSDATE,
    CONSTRAINT fk_qr_user FOREIGN KEY (UserId) REFERENCES KhachHang(MaKhachHang)
);
CREATE TABLE ChiNhanh (
    MaChiNhanh NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    TenChiNhanh NVARCHAR2(100) NOT NULL,
    DiaChi NVARCHAR2(200),
    SoDienThoai NVARCHAR2(20)
);

CREATE TABLE TADMIN.USER_SESSIONS (
    SESSION_ID VARCHAR2(64) PRIMARY KEY,
    USER_ID NUMBER NOT NULL,
    USER_TYPE NVARCHAR2(20) NOT NULL,
    DEVICE_TYPE NVARCHAR2(10) DEFAULT 'WEB' NOT NULL,
    LOGIN_TIME TIMESTAMP DEFAULT SYSTIMESTAMP,
    LAST_ACTIVITY TIMESTAMP DEFAULT SYSTIMESTAMP,
    IP_ADDRESS NVARCHAR2(50),
    DEVICE_INFO NVARCHAR2(200),
    IS_ACTIVE CHAR(1) DEFAULT 'Y' NOT NULL
);

CREATE INDEX IDX_USER_SESSION_STATUS ON TADMIN.USER_SESSIONS (USER_ID, USER_TYPE, IS_ACTIVE);

-- =====================================================
-- üîê 4. PROFILE KI·ªÇM SO√ÅT ƒêƒÇNG NH·∫¨P
-- =====================================================
CREATE PROFILE admin_profile LIMIT
    FAILED_LOGIN_ATTEMPTS 3             -- Sai m·∫≠t kh·∫©u 3 l·∫ßn th√¨ kh√≥a
    PASSWORD_LOCK_TIME 0.0003472        -- Kh√≥a 30s
    PASSWORD_LIFE_TIME 90               -- M·∫≠t kh·∫©u h·∫øt h·∫°n sau 90 ng√†y
    SESSIONS_PER_USER 3                 -- T·ªëi ƒëa 3 phi√™n ƒëƒÉng nh·∫≠p ƒë·ªìng th·ªùi
    IDLE_TIME 30                        -- T·ª± ng·∫Øt n·∫øu kh√¥ng ho·∫°t ƒë·ªông 30 ph√∫t
    CONNECT_TIME 240                    -- Gi·ªõi h·∫°n th·ªùi gian k·∫øt n·ªëi 4 ti·∫øng
    CPU_PER_SESSION UNLIMITED
    CPU_PER_CALL UNLIMITED
    LOGICAL_READS_PER_SESSION UNLIMITED;

CREATE PROFILE cus_profile LIMIT
    FAILED_LOGIN_ATTEMPTS 3
    PASSWORD_LOCK_TIME 0.0003472        -- Kh√≥a 30s
    PASSWORD_LIFE_TIME 180              -- Kh√°ch h√†ng ƒë·ªïi m·∫≠t kh·∫©u 6 th√°ng 1 l·∫ßn
    SESSIONS_PER_USER 3                 -- Ch·ªâ 1 phi√™n ƒëƒÉng nh·∫≠p duy nh·∫•t
    IDLE_TIME 15                        -- H·∫øt ho·∫°t ƒë·ªông 15 ph√∫t -> t·ª± ng·∫Øt
    CONNECT_TIME 120;                    -- Gi·ªõi h·∫°n 2 ti·∫øng m·ªói l·∫ßn ƒëƒÉng nh·∫≠p

CREATE PROFILE staff_profile LIMIT
    FAILED_LOGIN_ATTEMPTS 3
    PASSWORD_LIFE_TIME 90
    SESSIONS_PER_USER 1
    IDLE_TIME 30
    PASSWORD_GRACE_TIME 7;

-- =====================================================
-- üß© 5. ROLE PH√ÇN QUY·ªÄN
-- =====================================================
CREATE ROLE ROLE_ADMIN;
CREATE ROLE ROLE_CUSTOMER;
CREATE ROLE ROLE_STAFF;
CREATE ROLE ROLE_READ_ONLY;

-- Quy·ªÅn ƒëƒÉng nh·∫≠p
GRANT CREATE SESSION TO ROLE_ADMIN;
GRANT CREATE SESSION TO ROLE_CUSTOMER;

-- =====================================================
-- üõ† 6. C·∫§P QUY·ªÄN CHI TI·∫æT
-- =====================================================

-- ADMIN c√≥ to√†n quy·ªÅn
GRANT ALL PRIVILEGES TO ROLE_ADMIN;

-- CUSTOMER ch·ªâ c√≥ quy·ªÅn thao t√°c d·ªØ li·ªáu ng∆∞·ªùi d√πng v√† tour
GRANT SELECT ON KhachHang TO ROLE_CUSTOMER;
GRANT SELECT ON Tour TO ROLE_CUSTOMER;
GRANT SELECT, INSERT ON DatTour TO ROLE_CUSTOMER;
GRANT SELECT, INSERT ON DanhGiaTour TO ROLE_CUSTOMER;
GRANT SELECT, INSERT ON TinNhan TO ROLE_CUSTOMER;
GRANT SELECT, UPDATE ON KhachHang TO ROLE_CUSTOMER;

-- Ch·ªâ cho ph√©p xem tr√™n d·ªØ li·ªáu
GRANT SELECT ON KhachHang TO ROLE_READ_ONLY;
GRANT SELECT ON Tour TO ROLE_READ_ONLY;
GRANT SELECT ON DatTour TO ROLE_READ_ONLY;
GRANT SELECT ON DichVu TO ROLE_READ_ONLY;

-- Quy·ªÅn cho nh√¢n vi√™n
GRANT SELECT, UPDATE ON Tour TO ROLE_STAFF;
GRANT SELECT, UPDATE ON DichVu TO ROLE_STAFF;
GRANT SELECT, INSERT ON KhachHang TO ROLE_STAFF;
GRANT SELECT, INSERT ON DatTour TO ROLE_STAFF;
GRANT SELECT, INSERT, UPDATE ON HoaDon TO ROLE_STAFF;
GRANT CREATE SESSION TO ROLE_STAFF;

-- =====================================================
-- üë• 7. T·∫†O USER TRONG ORACLE
-- =====================================================
CREATE USER admin2 IDENTIFIED BY 123456
  PROFILE admin_profile
  DEFAULT TABLESPACE USERS
  TEMPORARY TABLESPACE TEMP;

GRANT ROLE_ADMIN TO admin2;
GRANT UNLIMITED TABLESPACE TO admin2;


CREATE USER cus1 IDENTIFIED BY 123456
    PROFILE cust_profile
    DEFAULT TABLESPACE USERS
    TEMPORARY TABLESPACE TEMP;
GRANT ROLE_CUSTOMER TO cus1;
GRANT UNLIMITED TABLESPACE TO cus1;

CREATE USER staff1 IDENTIFIED BY 123456
    PROFILE staff_profile
    DEFAULT TABLESPACE USERS
    TEMPORARY TABLESPACE TEMP;
GRANT ROLE_STAFF TO staff1;

-- =====================================================
-- üë• 8. VPD v√† Trigger c·∫ßn thi·∫øt
-- =====================================================
-- B∆∞·ªõc 1: T·∫°o Context v√† Package ƒë·ªÉ qu·∫£n l√Ω MaChiNhanh

-- T·∫°o m·ªôt context ƒë·ªÉ l∆∞u tr·ªØ m√£ chi nh√°nh c·ªßa ng∆∞·ªùi d√πng
CREATE OR REPLACE CONTEXT tour_management_ctx USING TADMIN.pkg_tour_management;
/

-- T·∫°o package ƒë·ªÉ set gi√° tr·ªã cho context
CREATE OR REPLACE PACKAGE TADMIN.pkg_tour_management AS
  -- Th·ªß t·ª•c n√†y s·∫Ω ƒë∆∞·ª£c g·ªçi t·ª´ ·ª©ng d·ª•ng ASP.NET ƒë·ªÉ g√°n m√£ chi nh√°nh
  PROCEDURE set_branch_id(branch_id IN NUMBER);
END pkg_tour_management;
/

CREATE OR REPLACE PACKAGE BODY TADMIN.pkg_tour_management AS
  PROCEDURE set_branch_id(branch_id IN NUMBER) IS
  BEGIN
    -- G√°n gi√° tr·ªã branch_id v√†o context 'tour_management_ctx'
    DBMS_SESSION.SET_CONTEXT('tour_management_ctx', 'branch_id', branch_id);
  END set_branch_id;
END pkg_tour_management;
/
-- B∆∞·ªõc 2: T·∫°o h√†m ch√≠nh s√°ch (Policy Function)

-- H√†m n√†y s·∫Ω ƒë∆∞·ª£c Oracle t·ª± ƒë·ªông g·ªçi m·ªói khi c√≥ truy v·∫•n ƒë·∫øn b·∫£ng TOUR.
-- N√≥ s·∫Ω tr·∫£ v·ªÅ m·ªôt m·ªánh ƒë·ªÅ WHERE ƒë·ªÉ l·ªçc d·ªØ li·ªáu d·ª±a tr√™n m√£ chi nh√°nh trong context.
CREATE OR REPLACE FUNCTION TADMIN.fn_vpd_tour_security(
  schema_name IN VARCHAR2,
  table_name IN VARCHAR2
)
RETURN VARCHAR2
AS
  v_branch_id VARCHAR2(100);
BEGIN
  -- L·∫•y m√£ chi nh√°nh t·ª´ context m√† ·ª©ng d·ª•ng ƒë√£ set
  v_branch_id := SYS_CONTEXT('tour_management_ctx', 'branch_id');

  -- N·∫øu ng∆∞·ªùi d√πng l√† ADMIN ho·∫∑c m·ªôt vai tr√≤ kh√¥ng ph·∫£i nh√¢n vi√™n,
  -- context s·∫Ω kh√¥ng ƒë∆∞·ª£c set, v√† h·ªç s·∫Ω th·∫•y t·∫•t c·∫£ c√°c tour.
  IF v_branch_id IS NULL THEN
    RETURN '1=1'; -- Tr·∫£ v·ªÅ ƒëi·ªÅu ki·ªán lu√¥n ƒë√∫ng (th·∫•y t·∫•t c·∫£)
  END IF;

  -- N·∫øu l√† nh√¢n vi√™n, ch·ªâ th·∫•y c√°c tour thu·ªôc chi nh√°nh c·ªßa h·ªç.
  RETURN 'MaChiNhanh = ' || v_branch_id;
END;
/
-- B∆∞·ªõc 3: G√°n ch√≠nh s√°ch VPD v√†o b·∫£ng TOUR (c√°ch ti·∫øp c·∫≠n m·ªõi)

-- Th·ª≠ nghi·ªám b·∫±ng c√°ch th√™m tham s·ªë update_check v√† ƒë·ªÉ statement_types m·∫∑c ƒë·ªãnh
BEGIN
  DBMS_RLS.ADD_POLICY(
    object_schema   => 'TADMIN',
    object_name     => 'TOUR',
    policy_name     => 'tour_branch_policy',
    function_schema => 'TADMIN',
    policy_function => 'fn_vpd_tour_security',
    update_check    => TRUE
  );
END;
/
-- B∆∞·ªõc 4: T·∫°o l·∫°i Trigger ƒë·ªÉ t·ª± ƒë·ªông g√°n chi nh√°nh khi t·∫°o tour

CREATE OR REPLACE TRIGGER TADMIN.trg_tour_branch_autofill
BEFORE INSERT ON TADMIN.TOUR
FOR EACH ROW
DECLARE
  v_branch_id NUMBER;
BEGIN
  -- L·∫•y m√£ chi nh√°nh t·ª´ context m√† ·ª©ng d·ª•ng ƒë√£ set
  v_branch_id := TO_NUMBER(SYS_CONTEXT('tour_management_ctx', 'branch_id'));

  -- N·∫øu m√£ chi nh√°nh t·ªìn t·∫°i trong context, g√°n n√≥ cho tour m·ªõi
  IF v_branch_id IS NOT NULL THEN
    :NEW.MaChiNhanh := v_branch_id;
  END IF;
EXCEPTION
  -- B·ªè qua l·ªói n·∫øu context kh√¥ng ƒë∆∞·ª£c set ho·∫∑c kh√¥ng ph·∫£i l√† s·ªë
  WHEN OTHERS THEN
    NULL;
END;
/
--- C·∫≠p nh·∫≠t VPD ƒë·ªÉ ph√¢n quy·ªÅn theo vai tr√≤ v√† chi nh√°nh
-- C·∫≠p nh·∫≠t package v√† h√†m ch√≠nh s√°ch ƒë·ªÉ x·ª≠ l√Ω theo vai tr√≤

-- C·∫≠p nh·∫≠t package ƒë·ªÉ c√≥ th·ªÉ set c·∫£ vai tr√≤ v√† chi nh√°nh
CREATE OR REPLACE PACKAGE TADMIN.pkg_tour_management AS
  PROCEDURE set_user_context(role_name IN VARCHAR2, branch_id IN NUMBER);
END pkg_tour_management;
/

CREATE OR REPLACE PACKAGE BODY TADMIN.pkg_tour_management AS
  PROCEDURE set_user_context(role_name IN VARCHAR2, branch_id IN NUMBER) IS
  BEGIN
    DBMS_SESSION.SET_CONTEXT('tour_management_ctx', 'role', role_name);
    DBMS_SESSION.SET_CONTEXT('tour_management_ctx', 'branch_id', branch_id);
  END set_user_context;
END pkg_tour_management;
/

-- C·∫≠p nh·∫≠t h√†m ch√≠nh s√°ch ƒë·ªÉ ki·ªÉm tra vai tr√≤
CREATE OR REPLACE FUNCTION TADMIN.fn_vpd_tour_security(
  schema_name IN VARCHAR2,
  table_name IN VARCHAR2
)
RETURN VARCHAR2
AS
  v_role VARCHAR2(100);
  v_branch_id VARCHAR2(100);
BEGIN
  v_role := SYS_CONTEXT('tour_management_ctx', 'role');
  v_branch_id := SYS_CONTEXT('tour_management_ctx', 'branch_id');

  -- Admin v√† Customer c√≥ th·ªÉ th·∫•y t·∫•t c·∫£ tour
  IF v_role = 'ROLE_ADMIN' OR v_role = 'ROLE_CUSTOMER' THEN
    RETURN '1=1'; 
  -- Nh√¢n vi√™n ch·ªâ th·∫•y tour thu·ªôc chi nh√°nh c·ªßa h·ªç
  ELSIF v_role = 'ROLE_STAFF' AND v_branch_id IS NOT NULL THEN
    RETURN 'MaChiNhanh = ' || v_branch_id;
  -- N·∫øu kh√¥ng c√≥ vai tr√≤ ho·∫∑c l√† vai tr√≤ kh√°c, kh√¥ng th·∫•y g√¨ c·∫£
  ELSE
    RETURN '1=0';
  END IF;
END;
/


-- üë• 9. Insert D·ªØ li·ªáu m·∫´u
-- =====================================================
INSERT INTO ChiNhanh (TenChiNhanh, DiaChi, SoDienThoai)
VALUES ('Mi·ªÅn B·∫Øc', 'S·ªë 12 Tr·∫ßn H∆∞ng ƒê·∫°o, H√† N·ªôi', '024-1234567');

INSERT INTO ChiNhanh (TenChiNhanh, DiaChi, SoDienThoai)
VALUES ('Mi·ªÅn Trung', '45 L√™ L·ª£i, ƒê√† N·∫µng', '0236-7654321');

INSERT INTO ChiNhanh (TenChiNhanh, DiaChi, SoDienThoai)
VALUES ('Mi·ªÅn Nam', '120 Nguy·ªÖn Hu·ªá, Qu·∫≠n 1, TP.HCM', '028-9876543');


