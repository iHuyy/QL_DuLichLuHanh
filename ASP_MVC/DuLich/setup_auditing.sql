-- Bước 1: Kích hoạt Standard Auditing cho bảng NHANVIEN
AUDIT SELECT, INSERT, UPDATE, DELETE ON TADMIN.NHANVIEN BY ACCESS;

-- Bước 2: Triển khai FGA trên bảng NHANVIEN
-- Yêu cầu gói DBMS_FGA
BEGIN
    DBMS_FGA.DROP_POLICY(
        object_schema      => 'TADMIN',
        object_name        => 'NHANVIEN',
        policy_name        => 'NHANVIEN_FGA_POLICY'
    );
EXCEPTION
    WHEN OTHERS THEN
        IF SQLCODE != -28102 THEN 
            RAISE;
        END IF;
END;
/

BEGIN
    DBMS_FGA.ADD_POLICY(
        object_schema      => 'TADMIN',
        object_name        => 'NHANVIEN',
        policy_name        => 'NHANVIEN_FGA_POLICY',
        audit_condition    => 'SYS_CONTEXT(''USERENV'', ''CLIENT_IDENTIFIER'') NOT LIKE ''TADMIN_ADMIN%''', -- Chỉ kiểm toán nếu không phải là ADMIN
        audit_column       => NULL, -- Kiểm toán tất cả các cột để sửa lỗi ORA-28140 và theo yêu cầu
        handler_schema     => NULL,
        handler_module     => NULL,
        enable             => TRUE,
        statement_types    => 'SELECT, UPDATE, INSERT, DELETE' -- Kiểm toán tất cả các loại thao tác
    );
END;
/

-- Bước 3: Tạo bảng kiểm toán tùy chỉnh
BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE TADMIN.NHANVIEN_AUDIT_LOG CASCADE CONSTRAINTS';
EXCEPTION
    WHEN OTHERS THEN
        IF SQLCODE != -942 THEN -- ORA-00942: table or view does not exist
            RAISE;
        END IF;
END;
/

-- Đơn giản hóa bảng log, bỏ cột TEN_BANG vì đã rõ ràng
CREATE TABLE TADMIN.NHANVIEN_AUDIT_LOG (
    MA_KIEM_TOAN        NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY,
    LOAI_HANH_DONG      VARCHAR2(10) NOT NULL, -- INSERT, UPDATE, DELETE
    TEN_COT             VARCHAR2(30), -- Tên cột bị thay đổi (chỉ cho UPDATE)
    GIA_TRI_CU          VARCHAR2(4000),
    GIA_TRI_MOI         VARCHAR2(4000),
    NGUOI_THUC_HIEN     VARCHAR2(100),
    THOI_GIAN_THUC_HIEN TIMESTAMP DEFAULT SYSTIMESTAMP,
    DINH_DANH_KHACH_HANG VARCHAR2(64), -- Từ SYS_CONTEXT('USERENV', 'CLIENT_IDENTIFIER')
    PRIMARY KEY (MA_KIEM_TOAN)
);

-- Bước 4: Tạo Trigger trên bảng NHANVIEN để ghi lại các thay đổi vào bảng kiểm toán tùy chỉnh
-- Trigger AFTER INSERT
CREATE OR REPLACE TRIGGER TADMIN.TRG_NHANVIEN_AFTER_INSERT
AFTER INSERT ON TADMIN.NHANVIEN
FOR EACH ROW
BEGIN
    INSERT INTO TADMIN.NHANVIEN_AUDIT_LOG (
        LOAI_HANH_DONG,
        GIA_TRI_CU,
        GIA_TRI_MOI,
        NGUOI_THUC_HIEN,
        DINH_DANH_KHACH_HANG
    ) VALUES (
        'INSERT',
        NULL,
        'MaNhanVien: ' || :NEW.MANHANVIEN || ', HoTen: ' || :NEW.HOTEN || ', Email: ' || :NEW.EMAIL || ', SoDienThoai: ' || :NEW.SODIENTHOAI || ', VaiTro: ' || :NEW.VAITRO || ', TrangThai: ' || :NEW.TRANGTHAI || ', MaChiNhanh: ' || :NEW.MACHINHANH,
        SYS_CONTEXT('USERENV', 'SESSION_USER'),
        SYS_CONTEXT('USERENV', 'CLIENT_IDENTIFIER')
    );
END;
/

-- Trigger BEFORE UPDATE (để ghi lại giá trị cũ và mới của các cột quan trọng)
CREATE OR REPLACE TRIGGER TADMIN.TRG_NHANVIEN_BEFORE_UPDATE
BEFORE UPDATE ON TADMIN.NHANVIEN
FOR EACH ROW
BEGIN
    -- Kiểm tra và ghi lại thay đổi cho cột HOTEN
    IF :OLD.HOTEN <> :NEW.HOTEN OR (:OLD.HOTEN IS NULL AND :NEW.HOTEN IS NOT NULL) OR (:OLD.HOTEN IS NOT NULL AND :NEW.HOTEN IS NULL) THEN
        INSERT INTO TADMIN.NHANVIEN_AUDIT_LOG (LOAI_HANH_DONG, TEN_COT, GIA_TRI_CU, GIA_TRI_MOI, NGUOI_THUC_HIEN, DINH_DANH_KHACH_HANG)
        VALUES ('UPDATE', 'HOTEN', :OLD.HOTEN, :NEW.HOTEN, SYS_CONTEXT('USERENV', 'SESSION_USER'), SYS_CONTEXT('USERENV', 'CLIENT_IDENTIFIER'));
    END IF;

    -- Kiểm tra và ghi lại thay đổi cho cột EMAIL
    IF :OLD.EMAIL <> :NEW.EMAIL OR (:OLD.EMAIL IS NULL AND :NEW.EMAIL IS NOT NULL) OR (:OLD.EMAIL IS NOT NULL AND :NEW.EMAIL IS NULL) THEN
        INSERT INTO TADMIN.NHANVIEN_AUDIT_LOG (LOAI_HANH_DONG, TEN_COT, GIA_TRI_CU, GIA_TRI_MOI, NGUOI_THUC_HIEN, DINH_DANH_KHACH_HANG)
        VALUES ('UPDATE', 'EMAIL', :OLD.EMAIL, :NEW.EMAIL, SYS_CONTEXT('USERENV', 'SESSION_USER'), SYS_CONTEXT('USERENV', 'CLIENT_IDENTIFIER'));
    END IF;

    -- Kiểm tra và ghi lại thay đổi cho cột SODIENTHOAI
    IF :OLD.SODIENTHOAI <> :NEW.SODIENTHOAI OR (:OLD.SODIENTHOAI IS NULL AND :NEW.SODIENTHOAI IS NOT NULL) OR (:OLD.SODIENTHOAI IS NOT NULL AND :NEW.SODIENTHOAI IS NULL) THEN
        INSERT INTO TADMIN.NHANVIEN_AUDIT_LOG (LOAI_HANH_DONG, TEN_COT, GIA_TRI_CU, GIA_TRI_MOI, NGUOI_THUC_HIEN, DINH_DANH_KHACH_HANG)
        VALUES ('UPDATE', 'SODIENTHOAI', :OLD.SODIENTHOAI, :NEW.SODIENTHOAI, SYS_CONTEXT('USERENV', 'SESSION_USER'), SYS_CONTEXT('USERENV', 'CLIENT_IDENTIFIER'));
    END IF;

    -- Kiểm tra và ghi lại thay đổi cho cột VAITRO
    IF :OLD.VAITRO <> :NEW.VAITRO OR (:OLD.VAITRO IS NULL AND :NEW.VAITRO IS NOT NULL) OR (:OLD.VAITRO IS NOT NULL AND :NEW.VAITRO IS NULL) THEN
        INSERT INTO TADMIN.NHANVIEN_AUDIT_LOG (LOAI_HANH_DONG, TEN_COT, GIA_TRI_CU, GIA_TRI_MOI, NGUOI_THUC_HIEN, DINH_DANH_KHACH_HANG)
        VALUES ('UPDATE', 'VAITRO', :OLD.VAITRO, :NEW.VAITRO, SYS_CONTEXT('USERENV', 'SESSION_USER'), SYS_CONTEXT('USERENV', 'CLIENT_IDENTIFIER'));
    END IF;

    -- Kiểm tra và ghi lại thay đổi cho cột TRANGTHAI
    IF :OLD.TRANGTHAI <> :NEW.TRANGTHAI OR (:OLD.TRANGTHAI IS NULL AND :NEW.TRANGTHAI IS NOT NULL) OR (:OLD.TRANGTHAI IS NOT NULL AND :NEW.TRANGTHAI IS NULL) THEN
        INSERT INTO TADMIN.NHANVIEN_AUDIT_LOG (LOAI_HANH_DONG, TEN_COT, GIA_TRI_CU, GIA_TRI_MOI, NGUOI_THUC_HIEN, DINH_DANH_KHACH_HANG)
        VALUES ('UPDATE', 'TRANGTHAI', :OLD.TRANGTHAI, :NEW.TRANGTHAI, SYS_CONTEXT('USERENV', 'SESSION_USER'), SYS_CONTEXT('USERENV', 'CLIENT_IDENTIFIER'));
    END IF;

    -- Kiểm tra và ghi lại thay đổi cho cột MACHINHANH
    IF :OLD.MACHINHANH <> :NEW.MACHINHANH OR (:OLD.MACHINHANH IS NULL AND :NEW.MACHINHANH IS NOT NULL) OR (:OLD.MACHINHANH IS NOT NULL AND :NEW.MACHINHANH IS NULL) THEN
        INSERT INTO TADMIN.NHANVIEN_AUDIT_LOG (LOAI_HANH_DONG, TEN_COT, GIA_TRI_CU, GIA_TRI_MOI, NGUOI_THUC_HIEN, DINH_DANH_KHACH_HANG)
        VALUES ('UPDATE', 'MACHINHANH', :OLD.MACHINHANH, :NEW.MACHINHANH, SYS_CONTEXT('USERENV', 'SESSION_USER'), SYS_CONTEXT('USERENV', 'CLIENT_IDENTIFIER'));
    END IF;

    -- Thêm các cột khác nếu cần
END;
/

-- Trigger AFTER DELETE
CREATE OR REPLACE TRIGGER TADMIN.TRG_NHANVIEN_AFTER_DELETE
AFTER DELETE ON TADMIN.NHANVIEN
FOR EACH ROW
BEGIN
    INSERT INTO TADMIN.NHANVIEN_AUDIT_LOG (
        LOAI_HANH_DONG,
        GIA_TRI_CU,
        GIA_TRI_MOI,
        NGUOI_THUC_HIEN,
        DINH_DANH_KHACH_HANG
    ) VALUES (
        'DELETE',
        'MaNhanVien: ' || :OLD.MANHANVIEN || ', HoTen: ' || :OLD.HOTEN || ', Email: ' || :OLD.EMAIL || ', SoDienThoai: ' || :OLD.SODIENTHOAI || ', VaiTro: ' || :OLD.VAITRO || ', TrangThai: ' || :OLD.TRANGTHAI || ', MaChiNhanh: ' || :OLD.MACHINHANH,
        NULL,
        SYS_CONTEXT('USERENV', 'SESSION_USER'),
        SYS_CONTEXT('USERENV', 'CLIENT_IDENTIFIER')
    );
END;
/

-- Để xem các bản ghi kiểm toán FGA:
-- SELECT * FROM DBA_FGA_AUDIT_TRAIL;

-- Để xem các bản ghi kiểm toán tiêu chuẩn:
-- SELECT * FROM DBA_AUDIT_TRAIL;

-- Để xem các bản ghi kiểm toán tùy chỉnh từ trigger:
-- SELECT * FROM TADMIN.NHANVIEN_AUDIT_LOG;

-- Để xóa chính sách FGA (nếu cần):
-- BEGIN
--    DBMS_FGA.DROP_POLICY(
--        object_schema      => 'TADMIN',
--        object_name        => 'NHANVIEN',
--        policy_name        => 'NHANVIEN_FGA_POLICY'
--    );
-- END;
-- /

-- Để tắt kiểm toán tiêu chuẩn (nếu cần):
-- NOAUDIT SELECT, INSERT, UPDATE, DELETE ON TADMIN.NHANVIEN;
